<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>市区町村別 枚数マップ</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    #map {
      height: 90vh;
      width: 100%;
    }

  .legend {
    line-height: 18px;
    color: #555;
    background: white;
    padding: 6px 8px;
    font: 14px Arial, sans-serif;
    box-shadow: 0 0 15px rgba(0,0,0,0.2);
    border-radius: 5px;
    z-index: 1000; /* ← これを追加 */
    position: relative; /* ← これも必要 */
  }

  .legend i {
    width: 18px;
    height: 18px;
    float: left;
    margin-right: 8px;
    opacity: 0.7;
  }
  </style>
</head>
<body>
  <h1>市区町村別 枚数マップ（Google Sheets公開CSV版）</h1>
  <div id="map"></div>

  <!-- 凡例 -->
  <div class="legend">
    <div class="legend-item"><div class="legend-color" style="background-color: #800026;"></div>500枚以上</div>
    <div class="legend-item"><div class="legend-color" style="background-color: #BD0026;"></div>100〜499枚</div>
    <div class="legend-item"><div class="legend-color" style="background-color: #E31A1C;"></div>50〜99枚</div>
    <div class="legend-item"><div class="legend-color" style="background-color: #FC4E2A;"></div>10〜49枚</div>
    <div class="legend-item"><div class="legend-color" style="background-color: #FD8D3C;"></div>1〜9枚</div>
    <div class="legend-item"><div class="legend-color" style="background-color: #EEE;"></div>0枚またはデータなし</div>
  </div>

  <!-- Leaflet -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <!-- PapaParse -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>

  <script>
    const SHEETS_CSV_URL =
      'https://raw.githubusercontent.com/aimerci/posting_status_map/refs/heads/main/data/posting_cityname_list%20-%20sum.csv';

    const map = L.map('map').setView([35.68, 139.76], 9);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© OpenStreetMap contributors',
    }).addTo(map);

    const GEOJSON_URL = 'https://raw.githubusercontent.com/aimerci/posting_status_map/refs/heads/main/geojson/N03-21_210101.geojson';

    let geojsonLayer = null;

    function getColor(count) {
      if (count >= 500) return '#800026';
      else if (count >= 100) return '#BD0026';
      else if (count >= 50) return '#E31A1C';
      else if (count >= 10) return '#FC4E2A';
      else if (count > 0) return '#FD8D3C';
      else return '#EEE';
    }

    function updateMap() {
      Promise.all([
        fetch(GEOJSON_URL).then((res) => res.json()),
        fetch(SHEETS_CSV_URL).then((res) => res.text()),
      ]).then(([geojson, csvText]) => {
        const data = Papa.parse(csvText, { header: true }).data;

        const countMap = {};
        const nameMap = {};
        data.forEach((d) => {
          countMap[d['N03_007']] = Number(d['枚数合計'] || 0);
          nameMap[d['N03_007']] = d['city_name'];
        });

        if (geojsonLayer) {
          geojsonLayer.remove();
        }

        geojsonLayer = L.geoJSON(geojson, {
          style: (feature) => {
            const code = feature.properties.N03_007;
            const count = countMap[code] || 0;
            return {
              fillColor: getColor(count),
              fillOpacity: 0.7,
              color: '#555',
              weight: 1,
            };
          },
          onEachFeature: (feature, layer) => {
            const code = feature.properties.N03_007;
            const count = countMap[code] || 0;
            const name = nameMap[code] || code;
            layer.bindPopup(`${name}: ${count} 枚`);
          },
        }).addTo(map);
      });
    }

    updateMap();

  const legend = L.control({ position: 'bottomright' });

  legend.onAdd = function (map) {
    const div = L.DomUtil.create('div', 'legend');
    const grades = [0, 10, 50, 100, 500];
    const labels = [];

    for (let i = 0; i < grades.length; i++) {
      const from = grades[i];
      const to = grades[i + 1];

      labels.push(
        '<i style="background:' + getColor(from + 1) + '"></i> ' +
        from + (to ? '&ndash;' + (to - 1) : '+')
      );
    }

    div.innerHTML = '<strong>枚数</strong><br>' + labels.join('<br>');
    return div;
  };

  legend.addTo(map);
  </script>
</body>
</html>
